project_name: pomerium-datasource
env:
- GO111MODULE=on
- CGO_ENABLED=0
release:
  github:
    owner: pomerium
    name: datasource
  prerelease: auto
  name_template: v{{.Version}}
milestones:
- repo:
    owner: pomerium
    name: datasource
  name_template: '{{ .Tag }}'
scoop:
  name: pomerium-datasource
  commit_author:
    name: goreleaserbot
    email: goreleaser@carlosbecker.com
  commit_msg_template: Scoop update for {{ .ProjectName }} version {{ .Tag }}
builds:
- id: datasource
  goos:
  - linux
  - darwin
  - windows
  - freebsd
  goarch:
  - amd64
  - arm
  - arm64
  goarm:
  - "6"
  - "7"
  gomips:
  - hardfloat
  targets:
  - linux_amd64
  - linux_arm_6
  - linux_arm_7
  - linux_arm64
  - darwin_amd64
  - windows_amd64
  - windows_arm_6
  - windows_arm_7
  - freebsd_amd64
  ignore:
  - goos: freebsd
    goarch: arm64
    goarm: ""
    gomips: ""
  - goos: freebsd
    goarch: arm
    goarm: ""
    gomips: ""
  dir: .
  main: ./cmd/pomerium-datasource
  ldflags:
  - -s -w
  - -X github.com/pomerium/datasource/version.Version={{.Version}}
  - -X github.com/pomerium/datasource/version.GitCommit={{.ShortCommit}}
  - -X github.com/pomerium/datasource/version.BuildMeta={{.Timestamp}}
  - -X github.com/pomerium/datasource/version.ProjectName={{.ProjectName}}
  - -X github.com/pomerium/datasource/version.ProjectURL=https://www.pomerium.com
  binary: pomerium-datasource
  lang: go
  gobinary: go
archives:
- id: datasource
  builds:
  - datasource
  name_template: '{{ .ProjectName }}-{{ .Os }}-{{ .Arch }}{{ if .Arm }}v{{ .Arm }}{{
    end }}'
  format: tar.gz
  format_overrides:
  - goos: windows
    format: zip
  files:
  - src: none*
  allow_different_binary_count: false
nfpms:
- file_name_template: '{{ .PackageName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}{{ if
    .Arm }}v{{ .Arm }}{{ end }}{{ if .Mips }}_{{ .Mips }}{{ end }}'
  package_name: datasource
  epoch: "1"
  release: "1"
  overrides:
    deb:
      file_name_template: '{{ .ProjectName }}_{{ .Version }}-{{ .Release }}_{{ .Arch
        }}{{ if .Arm }}{{if eq .Arm "7"}}hf{{ end }}{{ end }}'
      replacements:
        arm64: arm64
    rpm:
      file_name_template: '{{ .ProjectName }}-{{ .Version }}-{{ .Release }}.{{ .Arch
        }}{{ if .Arm }}{{if eq .Arm "7"}}hf{{ end }}{{ end }}'
      replacements:
        amd64: x86_64
        arm64: aarch64
  id: datasource
  builds:
  - datasource
  formats:
  - deb
  - rpm
  vendor: Pomerium, Inc.
  homepage: https://www.pomerium.com
  maintainer: Pomerium <info@pomerium.com>
  description: A tool to fetch external data sources for Pomerium, an identity aware
    proxy.
  license: Apache 2.0
  bindir: /usr/bin
snapshot:
  name_template: '{{ .Version }}+next+{{ .ShortCommit }}'
checksum:
  name_template: '{{ .ProjectName }}_checksums.txt'
  algorithm: sha256
dockers:
- goos: linux
  goarch: amd64
  dockerfile: Dockerfile.release
  image_templates:
  - pomerium/datasource:amd64-{{ .Tag }}
  build_flag_templates:
  - --pull
  - --platform=linux/amd64
  - --label=org.opencontainers.image.created={{.Date}}
  - --label=org.opencontainers.image.name={{.ProjectName}}
  - --label=org.opencontainers.image.revision={{.FullCommit}}
  - --label=org.opencontainers.image.version={{.Version}}
  - --label=org.opencontainers.image.source={{.GitURL}}
  - --label=repository=http://github.com/pomerium/datasource
  - --label=homepage=http://www.pomerium.com
  use: buildx
- goos: linux
  goarch: arm64
  dockerfile: Dockerfile.release
  image_templates:
  - pomerium/datasource:arm64v8-{{ .Tag }}
  build_flag_templates:
  - --pull
  - --platform=linux/arm64
  - --label=org.opencontainers.image.created={{.Date}}
  - --label=org.opencontainers.image.name={{.ProjectName}}
  - --label=org.opencontainers.image.revision={{.FullCommit}}
  - --label=org.opencontainers.image.version={{.Version}}
  - --label=org.opencontainers.image.source={{.GitURL}}
  - --label=repository=http://github.com/pomerium/datasource
  - --label=homepage=http://www.pomerium.com
  use: buildx
docker_manifests:
- name_template: pomerium/datasource:{{ .Tag }}
  image_templates:
  - pomerium/datasource:arm64v8-{{ .Tag }}
  - pomerium/datasource:amd64-{{ .Tag }}
  use: docker
dist: dist
env_files:
  github_token: ~/.config/goreleaser/github_token
  gitlab_token: ~/.config/goreleaser/gitlab_token
  gitea_token: ~/.config/goreleaser/gitea_token
before:
  hooks:
  - go mod download
source:
  name_template: '{{ .ProjectName }}-{{ .Version }}'
  format: tar.gz
gomod:
  gobinary: go
announce:
  twitter:
    message_template: '{{ .ProjectName }} {{ .Tag }} is out! Check it out at {{ .GitURL
      }}/releases/tag/{{ .Tag }}'
github_urls:
  download: https://github.com
gitlab_urls:
  download: https://gitlab.com
